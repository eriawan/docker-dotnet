# Build ASP.NET Core project using Azure Pipelines
# based from sample from MS docs: https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core?view=vsts

pool:
  vmImage: 'vs2017-win2016'
  
variables:
  buildConfiguration: 'Debug'
  imageName: '$(loginserver)/eriawan/netcorewiniis:2016ltsc-$(Build.BuildId)'

steps:
- script: |
    echo "Building docker image $(imageName)"
    docker build -f Dockerfile -t $(imageName) .
    echo "login to $(loginserver)"
    docker login -u $(dockerId) -p $(dockerPassword) $(loginserver)
    echo "execute docker push $(imageName)"
    docker push $(imageName)

  env:
    pswd: $(dockerPassword) 
    
- task: Docker@1
  displayName: 'Run the docker container'
  inputs:
    containerregistrytype: 'Azure Container Registry'
    azureSubscriptionEndpoint: 'AzSponsorConnection'
    azureContainerRegistry: $(loginserver)
    command: 'run'
    imageName: '$(imageName)'
    containerName: eriawancontainer
    ports: 80
    restartPolicy: always

- script: |
    echo "Install AZ CLI using nodeJS npm"
    npm install --global windows-build-tools
    npm install -g azure-cli

# - task: PublishBuildArtifacts@1